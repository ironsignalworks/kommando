<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>KOMMANDO — Opaque Logo + Paranoid Type</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Courier+Prime:wght@400&family=Special+Elite&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000;

      /* timing */
      --spawn-ms: 2200;     /* drip build */
      --sim-ms:   1800;     /* build end -> fade skull + paint */
      --ansi-ms:  1600;     /* skull type-in speed */
      --neon-ms:  1800;     /* neon shower duration after reveal */

      /* ink look (light) */
      --max-particles: 200;
      --gutter: 24;

      --fade-alpha: 0.010;  /* build-phase decay inside mask */
      --red-core:   #b30000;/* final solid logo */
      --ink-a:      rgba(210,0,0,0.70);
      --ink-b:      rgba(120,0,0,0.55);
      --ink-tail:   rgba(90,0,0,0.55);
      --ink-add:    rgba(255,80,80,0.16);

      /* physics */
      --grav: 0.050;
      --drag: 0.990;
      --stick-x: 0.92;
      --stick-y: 0.86;
      --wander: 0.05;
      --edge-bleed: 0.22;

      /* clears */
      --fadeout-alpha: 1.22; /* clears paint after build */
      --neon-clear:    1.30; /* clears neon each frame */

      /* skull fade-out speed after reveal */
      --skull-fade-alpha: 0.20; /* per frame */
    }

    html,body{
      height:100%; margin:0; background:var(--bg); color:#cfcfcf;
      font-family:'Share Tech Mono', monospace;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
    }
    .wrap{
      width:min(1200px,96vw); height:min(720px,92vh);
      position:relative; background:#060606; box-shadow:0 0 0 1px #111 inset;
    }

    /* Stacking: skull under, logo over, paint/top effects above logo, type on top */
    canvas{ position:absolute; inset:0; display:block; image-rendering:pixelated; }
    #ansi{  z-index:0 }  /* skull */
    #logo{  z-index:1 }  /* final opaque wordmark */
    #paint{ z-index:2 }  /* drips / neon */
    #type{  z-index:3 }  /* paranoid caption */
    #hint{
      position:absolute; left:50%; bottom:10px; transform:translateX(-50%);
      font-size:12px; letter-spacing:.06em; opacity:.85; z-index:4; user-select:none;
      text-shadow:0 0 6px rgba(255,0,0,.25);
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <canvas id="ansi"></canvas>   <!-- skull (under) -->
    <canvas id="logo"></canvas>   <!-- opaque red logo -->
    <canvas id="paint"></canvas>  <!-- drips / neon -->
    <canvas id="type"></canvas>   <!-- typewriter -->
    <div id="hint">SPACE / CLICK — replay</div>
  </div>

  <!-- ASCII mask -->
  <script type="text/plain" id="ascii-src">



    
    █████   ████    ███████    ██████   ██████ ██████   ██████   █████████   ██████   █████ ██████████      ███████
    ▒▒███   ███▒   ███▒▒▒▒▒███ ▒▒██████ ██████ ▒▒██████ ██████   ███▒▒▒▒▒███ ▒▒██████ ▒▒███ ▒▒███▒▒▒▒███   ███▒▒▒▒▒███
     ▒███  ███    ███     ▒▒███ ▒███▒█████▒███  ▒███▒█████▒███  ▒███    ▒███  ▒███▒███ ▒███  ▒███   ▒▒███ ███     ▒▒███
     ▒███████    ▒███      ▒███ ▒███▒▒███ ▒███  ▒███▒▒███ ▒███  ▒███████████  ▒███▒▒███▒███  ▒███    ▒███▒███      ▒███
     ▒███▒▒███   ▒███      ▒███ ▒███ ▒▒▒  ▒███  ▒███ ▒▒▒  ▒███  ▒███▒▒▒▒▒███  ▒███ ▒▒██████  ▒███    ▒███▒███      ▒███
     ▒███ ▒▒███  ▒▒███     ███  ▒███      ▒███  ▒███      ▒███  ▒███    ▒███  ▒███  ▒▒█████  ▒███    ███ ▒▒███     ███
     █████ ▒▒████ ▒▒▒███████▒   █████     █████ █████     █████ █████   █████ █████  ▒▒█████ ██████████   ▒▒▒███████▒
    ▒▒▒▒▒   ▒▒▒▒    ▒▒▒▒▒▒▒    ▒▒▒▒▒     ▒▒▒▒▒ ▒▒▒▒▒     ▒▒▒▒▒ ▒▒▒▒▒   ▒▒▒▒▒ ▒▒▒▒▒    ▒▒▒▒▒ ▒▒▒▒▒▒▒▒▒▒      ▒▒▒▒▒▒▒
  </script>

  <!-- Skull block (raw; no ANSI escapes) -->
  <script type="text/plain" id="skull-src">                                     
                                                                                                                    
                                                   ███  ▒ ▓▓  ░█                                                    
                                             ▒███▒█▓██░░░░████████▒▒███▓██                                          
                                        █▓ ▒    ░███▒░█▒███████████████████████                                     
                                      ███  ░█▓▒       ░████████████████████████████                                 
                                    ███████▓░░░░   ██████████████▓░▒███████████▓███▓░                               
                                    ███████████▓░░▓▓▓██████████░ ▓▓▒░██░ ▒███████████▓▓                             
                                ░░▓█▓▓███▓████████████████▒   ░▓ ░████████████████████████                          
                               ██████▓    ░▒░░░▓█████████████▓░▓▓██████▓███████████████████                         
                              ████████████░░░████████▓███████████████████████████████████████                       
                              ███████████████████▓░░░▒  ░█████████████████████████████████████                      
                              ████████████████████████▒█▒  ▒█▓░░      ░▒▓███████████████████▓█░                     
                             ████████░██████████████████████████████████▓▓▓▓▓░░░▓█████▒░█▓█████                     
                             █████▓   ██▓█████████████████████████████████████▒█████████████████                    
                             ███▓ ░▓███▓▒▒░░                ░▒▒▒▓████████████████████████▒████▒█                    
                             █░░██▒     ░       ░             ░▒▓░      ░▓██████▒██████▒  ░█▓ ▒█                    
                            ███░       ▓▒ ░▒░▓   ░░ ░     ▒░     ░█░▓▓█▓     ░░▓███████▒█░    ░█                    
                           ██▓    ░█▓░██▒ ▓█▓▓▓▓▒█▓ █░▓  ▒▓    ░██▓▓▒▒███▒ ░ ██░   ░██▓▓▓░    ▓█                    
                           █▓         █▓▒ ░█▓▓ ░░▒ ░░▓    ▓▓░  ███▓██▒█▓██░░ ▒███░     ▒█▓░░▓ ██                    
                           █▒      ░░▒█▒░   ▓▓░█░▒  █      █▓░ ███░███░███░  ▓████       ░█▓ ▒█                     
                            █░     ░░▒███░      ░  █░   ░  ▒███ ▒▒█░░▒███▒   █████▒   ░▒░  ░█░█                     
                             ▓      ██░▓██▓█████  ▓░   ▓▒   ███░█░         ░███████░ ▓   █░  ██                     
                             ▓      ░▓███▒░ ░▓   ░█ ▒  ▓▓   ▒██░███████████████████▓░█   █░   ██                    
                             ▓     ░██████▓▒█▒    █▒░░▓██░░░████░ ░░▒███████████████▓    █░    ██                   
                            █▒      ▒██████████  ░██▓▓▒▒▒▒░▓█▓██░ █▒█████████████████    ▓  ░█ ██                   
                            █     ░█ █▒░██▒▓░      ▒▓█▓▒█▒█▓█████  █▒███████████████▓    ▓ ░█                       
                            █     ▒   █░         ▒▓█▒█▒▓█▒█▓▓███▓░   ░▒███▒▒░     ▓▓█   █▓ ▓                        
                            █    ░█  ██▒ ▒▒░     ░░▒█░▓▒▓██▒▒████░     ▓████▓░ █░█      █░ █                        
                            █    ░█  ███▒▓▒    ░▒░▒▒▒▒█▒█▓▒█▓▓█▒█░▒░   ▒█████░▓▓██      ▓  █                        
                            █    ░█  ███████▓▒█░░█▒████░█▒██▒██▒█▓█▒    █████░░██       ▓ ░█                        
                            ▒     ▓ ██░▓▒█▒███████           ░░ ░      ░█████▓██        ▓ ░█                        
                           █     ░█ ███▓   ░▓██░▒░▒░ ░     ░▒░     ▒   ▓████████        ▓  █                        
                          █▒     ░█    █░ ▒        ░░            █░    ████████         ▓  █                        
                          ▓      ▒      ▓ ░▒     ░▓░▓███░██▓░█▒█▓█░░   ████████         █░ ▓                        
                         █░     ░█      █░ ░         ▒ ▓░▓▒█░█▒░▒░██▒ ▓███▒███           ▓ ▓                        
                        █▒     ░▓        ▓     ░    ░█░█ █░░▒░█░████▒ ███▓███            █░░█                       
                        ▓      ▒         █▒░▓  ░▒░ ░  ▓█▓▓██████████░▓██░▒██              ▓▒▒██                     
                       █░     ▒█          █▒▓▓░░░░▒░  ▓░░▓█████████████▓▒█                █░ ██                     
                      █░     ░█            █▓▓█▒▒   █▓█░█▓████████████░ ██                █▒░██                     
                    ██░     ░█               █████▒ █▓  ██████████▓█▒ ░██                 █▒░██                     
                   █░      ░█                 ██▒▓▒░     ██▒░▒███░░   ▓██                 █░░██                     
                  █░      ░█                   █░██████▓░ ██▓░░▒█████▒███                 ▓░░▓█                     
                 █░      ░█                    █▒██████▓░ ███████████▓▓██                █░▒ ░█                     
                █░      ▒█                     █████████▒ ████▒█████▒▓███                ▓ █░█                      
               ▓░      ▓█                       ██████▓▓  ██████████████                █░ ▓▓█                      
             █▒      ░█                          ██████▓░ ██████▒▓████                 █▓ ░▓█                       
             ▒     ░▓█                              ███▓░░██▒▓█████                    ▓  ░█                        
            █▒   ░▒█                                                                  █░ ▒██                        
             █████                                                                    ▓ ▒█                          
                                                                                     █░░█                           
                                                                                     ▒ ▓█                           
                                                                                    █░▒█                            
                                                                                    ▒░█                             
                                                                                   █▒█                              
                                                                                                                    
                                                                                                                    
                                                                                                                    
  </script>

  <script>
    (async function(){
      const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
      const wrap   = document.getElementById('wrap');
      const ansiC  = document.getElementById('ansi');  const ansiCtx  = ansiC.getContext('2d'); // skull
      const logoC  = document.getElementById('logo');  const logoCtx  = logoC.getContext('2d'); // final logo
      const paintC = document.getElementById('paint'); const pctx     = paintC.getContext('2d', { alpha:true });
      const typeC  = document.getElementById('type');  const typeCtx  = typeC.getContext('2d');
  
      const ASCII_LOGO = document.getElementById('ascii-src').textContent.replace(/\r/g,'');
      const SKULL_RAW  = document.getElementById('skull-src').textContent;
  
      if (document.fonts && document.fonts.ready) { try { await document.fonts.ready; } catch(e){} }
  
      let w=0, h=0, gutter=14;
      let maskData=null, mW=0, mH=0, logoBox=null, chW=0, chH=0, rows=0, cols=0, offX=0, offY=0, fontPx=0;
  
      const css = () => getComputedStyle(document.documentElement);
      const MAX = () => parseInt(css().getPropertyValue('--max-particles')) || 1200;
  
      let particles=[], spawnUntil=0, stopAt=0, neonUntil=0, rafId=0, finalized=false;
  
      // phases: 0 BUILD, 1 FADE_PAINT, 2 NEON, 3 DONE
      let phase = 0;
  
      // skull text layout
      let skullLines=[], skullGeom=null, skullStart=0;
  
      // paranoid typewriter
      const TYPE_TEXT='FOG OF WAR';
  
      function fitCanvas(cv){
        const r = wrap.getBoundingClientRect();
        cv.width  = Math.floor(r.width * DPR);
        cv.height = Math.floor(r.height * DPR);
        cv.style.width  = r.width + 'px';
        cv.style.height = r.height + 'px';
      }
  
      function layout(){
        [ansiC, logoC, paintC, typeC].forEach(fitCanvas);
        const r = wrap.getBoundingClientRect();
        w = r.width; h = r.height;
  
        [ansiCtx, logoCtx, pctx, typeCtx].forEach(ctx => {
          ctx.setTransform(DPR,0,0,DPR,0,0);
          ctx.globalCompositeOperation = 'source-over';
          ctx.globalAlpha = 1;
          ctx.clearRect(0,0,w,h);
        });
  
        // --- ASCII mask metrics ---
        const lines = ASCII_LOGO.split('\n');
        rows = lines.length;
        cols = Math.max(...lines.map(l=>l.length || 0));
  
        fontPx = Math.floor(Math.min(
          w / Math.max(8, (cols + 2)),
          h / Math.max(6, (rows + 0.9))
        ));
        fontPx = Math.max(12, Math.min(fontPx, 40));
  
        mW = Math.floor(w * DPR);
        mH = Math.floor(h * DPR);
        const mcv = document.createElement('canvas');
        mcv.width = mW; mcv.height = mH;
        const mctx = mcv.getContext('2d');
        mctx.setTransform(DPR,0,0,DPR,0,0);
        mctx.clearRect(0,0,w,h);
        mctx.fillStyle = '#fff';
        mctx.font = `${fontPx}px "Courier Prime","Share Tech Mono", monospace`;
        mctx.textBaseline='top';
  
        chW = mctx.measureText('M').width;
        chH = fontPx * 1.2;
        const blockW = chW * cols;
        const blockH = chH * rows;
  
        offX = Math.floor((w - blockW)/2);
        offY = Math.floor((h - blockH)/2);
  
        for (let r=0;r<rows;r++){
          const line = lines[r];
          if (line && line.trim().length) mctx.fillText(line, offX, offY + r*chH);
        }
        maskData = mctx.getImageData(0,0,mW,mH).data;
  
        logoBox = {x: offX, y: offY, w: blockW, h: blockH};
  
        // --- Skull placement (right of logo) ---
        skullLines = SKULL_RAW.replace(/\r/g,'').split('\n');
        const sRows = skullLines.length;
        const sCols = skullLines.reduce((m,l)=>Math.max(m,l.length),0);
  
        const rightPad = 10, gutter = 14;
        const rightAvailW = Math.max(0, w - (offX + logoBox.w + gutter) - rightPad);
        const rightAvailH = h - 32;
  
        let sFontPx = Math.floor(Math.min(
          (rightAvailW>0? rightAvailW : w/2) / Math.max(6,(sCols+1)),
          rightAvailH / Math.max(6,(sRows+0.5))
        ));
        sFontPx = Math.max(8, Math.min(sFontPx, 28));
        ansiCtx.font = `${sFontPx}px "Courier Prime","Share Tech Mono", monospace`;
        ansiCtx.textBaseline = 'top';
        const sChW = ansiCtx.measureText('M').width;
        const sChH = sFontPx * 1.2;
  
        const sTotalW = sChW * sCols;
        const sTotalH = sChH * sRows;
  
        let left = offX + logoBox.w + gutter;
        left = Math.min(left, w - sTotalW - rightPad);
        const top  = Math.max(16, Math.floor((h - sTotalH)/2));
  
        skullGeom = { left, top, cols:sCols, rows:sRows, chW:sChW, chH:sChH, fontPx:sFontPx };
      }
  
      /* --------- helpers --------- */
      function maskAtSmooth(x,y){
        if(!maskData) return 0;
        const taps = [[x,y],[x+0.35,y+0.15],[x-0.35,y-0.15],[x,y+0.35]];
        let acc = 0;
        for(const [sx,sy] of taps){
          const ix = Math.max(0, Math.min(mW-1, Math.floor(sx * DPR)));
          const iy = Math.max(0, Math.min(mH-1, Math.floor(sy * DPR)));
          const idx = (iy * mW + ix) * 4 + 3; // alpha
          acc += (maskData[idx] > 10) ? 1 : 0;
        }
        return acc / taps.length;
      }
      function field(x,y){
        const l=maskAtSmooth(x-1,y), r=maskAtSmooth(x+1,y), u=maskAtSmooth(x,y-1), d=maskAtSmooth(x,y+1);
        return {gx:(r-l), gy:(d-u)};
      }
  
      function spawnParticle(build=true){
        const band = Math.max(20, Math.floor(logoBox.w * 0.85));
        const startX = Math.max(logoBox.x, logoBox.x + logoBox.w/2 - band/2);
        const wander = parseFloat(css().getPropertyValue('--wander'))||0.05;
        const baseVy = build ? (0.55 + Math.random()*0.45) : (0.75 + Math.random()*0.35);
        const r  = build ? (1.6 + Math.random()*2.2) : (1.0 + Math.random()*1.6);
        return {
          x: startX + Math.random()*band,
          y: (logoBox.y - 60) - Math.random()*60,
          vx:(Math.random()-0.5) * wander,
          vy: baseVy,
          r,
          life: 0,
          px: null, py: null,
          neon: !build
        };
      }
  
      function deposit(p, mode){
        const inside = maskAtSmooth(p.x,p.y) > 0.18;
        pctx.save();
        if(mode==='BUILD'){
          pctx.beginPath(); pctx.rect(logoBox.x, logoBox.y, logoBox.w, logoBox.h); pctx.clip();
        }
        if(p.px!==null){
          const cx = (p.px + p.x) * 0.5;
          const cy = (p.py + p.y) * 0.5 - Math.min(4, p.vy*1.8);
  
          pctx.globalCompositeOperation = (mode==='NEON') ? 'screen' : 'lighter';
          pctx.globalAlpha = (mode==='NEON') ? 0.6 : 0.75;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim();
          pctx.lineWidth = Math.max(0.9, p.r*0.70);
          pctx.lineCap = 'round';
          pctx.beginPath(); pctx.moveTo(p.px, p.py);
          pctx.quadraticCurveTo(cx, cy, p.x, p.y);
          pctx.stroke();
  
          pctx.globalCompositeOperation = 'source-over';
          pctx.globalAlpha = (mode==='NEON') ? 0.45 : 0.55;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-tail').trim();
          pctx.lineWidth = Math.max(0.7, p.r*0.48);
          pctx.beginPath(); pctx.moveTo(p.px, p.py+0.3);
          pctx.quadraticCurveTo(cx, cy+0.3, p.x, p.y-0.2);
          pctx.stroke();
        }
        const g = pctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*1.2);
        g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim());
        g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--ink-b').trim());
        pctx.globalCompositeOperation = (mode==='NEON') ? 'screen' : 'lighter';
        pctx.globalAlpha = (mode==='NEON') ? 0.65 : 0.75;
        pctx.fillStyle = g;
        pctx.beginPath(); pctx.arc(p.x, p.y, p.r, 0, Math.PI*2); pctx.fill();
  
        if(mode==='BUILD' && inside){
          const bleed = parseFloat(css().getPropertyValue('--edge-bleed'))||0.22;
          const F = field(p.x,p.y);
          const tx = -F.gy, ty = F.gx;
          const norm = Math.hypot(tx,ty)||1;
          const ex = (tx/norm)*(p.r*1.1);
          const ey = (ty/norm)*(p.r*1.1);
          pctx.globalCompositeOperation = 'lighter';
          pctx.globalAlpha = 0.5;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim();
          pctx.lineWidth = Math.max(0.6, p.r*0.42*bleed);
          pctx.beginPath();
          pctx.moveTo(p.x - ex, p.y - ey);
          pctx.lineTo(p.x + ex, p.y + ey);
          pctx.stroke();
        }
        pctx.restore();
        p.px = p.x; p.py = p.y;
      }
  
      function drawSkullFrame(ts){
        if(!skullGeom) return;
        const {left, top, cols, rows, chW, chH, fontPx} = skullGeom;
        const t = Math.max(0, Math.min(1, (ts - skullStart)/ (parseInt(css().getPropertyValue('--ansi-ms'))||2600)));
        const revealCols = Math.ceil(cols * t);
  
        // draw skull progressively; DO NOT FADE afterwards
        ansiCtx.save();
        ansiCtx.globalCompositeOperation = 'source-over';
        ansiCtx.clearRect(0,0,w,h);
        ansiCtx.font = `${fontPx}px "Courier Prime","Share Tech Mono", monospace`;
        ansiCtx.textBaseline = 'top';
        ansiCtx.fillStyle = '#eaeaea';
        for (let r=0;r<rows;r++){
          const slice = (skullLines[r]||'').slice(0,revealCols);
          if (slice.trim().length){
            ansiCtx.fillText(slice, left + (cols - slice.length)*chW, top + r*chH);
          }
        }
        ansiCtx.restore();
      }
  
      function finalSolidLogo(){
        if(finalized) return; finalized = true;
        // draw OPAQUE logo (this sits above skull canvas)
        logoCtx.save();
        logoCtx.globalCompositeOperation='source-over';
        logoCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--red-core').trim() || '#b30000';
        logoCtx.font = `${fontPx}px "Courier Prime","Share Tech Mono", monospace`;
        logoCtx.textBaseline = 'top';
        const lines = ASCII_LOGO.split('\n');
        for (let r=0;r<rows;r++){
          const line = lines[r];
          if (line && line.trim().length) logoCtx.fillText(line, offX, offY + r*chH);
        }
        logoCtx.restore();
        // skull stays — no fade
      }
  
      /* -------- Paranoid typewriter (Special Elite, no lines/boxes) -------- */
      function startTypewriter(){
        const maxW = Math.floor(logoBox.w*0.95);
        const ts = Math.min(64, Math.max(18, Math.floor(maxW/(TYPE_TEXT.length*0.62))));
        const y  = Math.min(h-40, logoBox.y + logoBox.h + Math.max(24, Math.floor(logoBox.h*0.08)));
        const cx = Math.floor(logoBox.x + logoBox.w/2);
  
        let idx=0, typing=true, caretOn=true;
  
        const draw = () => {
          // clear only a tight strip around text—no decorative lines
          typeCtx.clearRect(logoBox.x, y-ts*1.2, logoBox.w, ts*2.4);
  
          typeCtx.textBaseline='middle'; typeCtx.textAlign='center';
          const txt = TYPE_TEXT.slice(0, idx);
  
          // subtle double-pass jitter; no extra shapes
          typeCtx.font = `${Math.round(ts)}px "Special Elite", "Courier Prime", monospace`;
  
          // ghost pass
          typeCtx.globalAlpha = 0.65;
          typeCtx.fillStyle = '#e6e6e6';
          typeCtx.fillText(txt, cx + (Math.random()*0.8-0.4), y + (Math.random()*0.8-0.4));
  
          // main pass
          typeCtx.globalAlpha = 0.95;
          typeCtx.fillText(txt, cx + (Math.random()*0.4-0.2), y + (Math.random()*0.4-0.2));
  
          // caret (no box)
          if(typing && caretOn){
            const measureAll = typeCtx.measureText(TYPE_TEXT);
            const pre = TYPE_TEXT.slice(0, Math.max(0,idx));
            const meas = typeCtx.measureText(pre);
            const caretX = cx - (measureAll.width/2) + meas.width + 3;
            const ch = Math.floor(ts*0.96);
            typeCtx.globalAlpha = 0.85;
            typeCtx.fillRect(caretX, y - ch*0.55, Math.max(2, ts*0.07), ch*0.95);
          }
  
          typeCtx.globalAlpha = 1;
        };
  
        (function step(){
          if(idx<=TYPE_TEXT.length){ draw(); idx++; setTimeout(step, 48 + (Math.random()*40|0)); }
          else { typing=false; draw(); }
        })();
  
        (function blink(){
          caretOn = !caretOn;
          if(!typing) { draw(); return; }
          draw(); setTimeout(blink, 360 + (Math.random()*240|0));
        })();
      }
  
      function tick(ts){
        // phase transitions
        if(phase===0 && ts >= stopAt){                // BUILD -> FADE_PAINT
          phase = 1; finalSolidLogo();
        }
        if(phase===1 && ts >= stopAt + 500){          // after brief paint fade, move to neon
          phase = 2;
        }
        if(phase===2 && ts >= neonUntil){             // NEON end
          phase = 3;
        }
  
        // per-phase clears (paint)
        if(phase===0){
          pctx.save();
          pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--fade-alpha')||0.010})`;
          pctx.fillRect(logoBox.x, logoBox.y, logoBox.w, logoBox.h);
          pctx.restore();
        } else if(phase===1){
          pctx.save();
          pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--fadeout-alpha')||0.22})`;
          pctx.fillRect(0,0,w,h);
          pctx.restore();
        } else if(phase===2){
          pctx.save();
          pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--neon-clear')||0.30})`;
          pctx.fillRect(0,0,w,h);
          pctx.restore();
        }
  
        // spawn / simulate
        const G = parseFloat(css().getPropertyValue('--grav'))||0.05;
        const DRAG = parseFloat(css().getPropertyValue('--drag'))||0.990;
  
        if(phase===0 && ts<spawnUntil && particles.length<MAX()){
          for(let i=0;i<8;i++) particles.push(spawnParticle(true));
        }
        if(phase===2 && particles.length<Math.floor(MAX()*0.35)){
          for(let i=0;i<6;i++) particles.push(spawnParticle(false));
        }
  
        for(let i=particles.length-1;i>=0;i--){
          const p=particles[i];
          p.vy += G;
          const F=field(p.x,p.y);
          p.vx += F.gx*0.12;
          p.vy += F.gy*0.12;
          p.vx *= DRAG; p.vy *= DRAG;
          p.px = (p.px===null)? p.x : p.x;
          p.py = (p.py===null)? p.y : p.y;
          p.x  += p.vx; p.y  += p.vy;
          p.life++;
  
          if(phase===0){
            if(maskAtSmooth(p.x,p.y)>0.18){
              p.vx *= (parseFloat(css().getPropertyValue('--stick-x'))||0.92);
              p.vy  = Math.max(0.18, p.vy*(parseFloat(css().getPropertyValue('--stick-y'))||0.86));
            }
            deposit(p,'BUILD');
          } else if(phase===2){
            deposit(p,'NEON');
          }
  
          if(p.x<-24||p.x>w+24||p.y>h+50) particles.splice(i,1);
        }
  
        // skull draw (no fade)
        drawSkullFrame(ts);
  
        if(phase<3){ rafId=requestAnimationFrame(tick); }
      }
  
      function start(){
        cancelAnimationFrame(rafId);
        finalized=false;
        particles.length = 0;
        phase = 0;
  
        [ansiCtx, logoCtx, pctx, typeCtx].forEach(ctx=>{
          ctx.setTransform(1,0,0,1,0,0);
          ctx.globalCompositeOperation='source-over';
          ctx.globalAlpha=1;
          ctx.clearRect(0,0,99999,99999);
        });
  
        layout();
  
        const now = performance.now();
        skullStart = now;
        spawnUntil = now + (parseInt(css().getPropertyValue('--spawn-ms'))||5200);
        stopAt     = now + (parseInt(css().getPropertyValue('--sim-ms'))  ||9800);
        neonUntil  = stopAt + (parseInt(css().getPropertyValue('--neon-ms'))||2800);
  
        setTimeout(()=> startTypewriter(), Math.max(80, (spawnUntil-now) + 150));
        rafId = requestAnimationFrame(tick);
      }
  
      window.addEventListener('resize', start, {passive:true});
      window.addEventListener('keydown', e=>{ if(e.code==='Space'){ e.preventDefault(); start(); }} );
      window.addEventListener('click', start, {passive:true});
  
      start();
    })();
    </script>
  </body>
  </html>