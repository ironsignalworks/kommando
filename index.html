<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>KOMMANDO — Fog of War</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Courier+Prime:wght@400&family=Special+Elite&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />
  <!-- Added: JetBrains Mono to keep block glyphs truly monospaced -->
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet" />
  
  <link rel="icon" href="./favicon.ico" />

  <!-- Primary SEO -->
  <meta name="title" content="KOMMANDO — Fog of War" />
  <meta name="description" content="Dive into real-time caverns where every step echoes madness. Tactical pixel warfare meets paranoia in a collapsing underground world. Welcome to the Fog of War." />
  <meta name="keywords" content="kommando, fog of war, Catastrophic Labs, pixel roguelite, tactical shooter, retro arcade, browser game, real-time caverns, paranoia, extraction" />
  <meta name="author" content="Catastrophic Labs" />
  <link rel="canonical" href="https://ironsignalworks.github.io/kommando/" />

  <!-- Open Graph -->
  <meta property="og:title" content="KOMMANDO — Fog of War" />
  <meta property="og:description" content="Dive into real-time caverns where every step echoes madness. Tactical pixel warfare meets paranoia in a collapsing underground world. Welcome to the Fog of War." />
  <meta property="og:image" content="https://ironsignalworks.github.io/kommando/card.jpg" />
  <meta property="og:image:type" content="image/jpeg" />
  <meta property="og:image:alt" content="KOMMANDO — Fog of War preview image" />
  <meta property="og:url" content="https://ironsignalworks.github.io/kommando/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Catastrophic Labs" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="KOMMANDO — Fog of War" />
  <meta name="twitter:description" content="Dive into real-time caverns where every step echoes madness. Tactical pixel warfare meets paranoia in a collapsing underground world. Welcome to the Fog of War." />
  <meta name="twitter:image" content="https://ironsignalworks.github.io/kommando/card.jpg" />
  <meta name="twitter:image:alt" content="KOMMANDO — Fog of War preview image" />
  <!-- <meta name="twitter:creator" content="@CatastrophicLabs" /> -->

  <script defer src="audio.js"></script>

  <!-- Nice-to-haves -->
  <meta name="theme-color" content="#0a1208" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />

  <style>
    :root{
      --bg:#051307;
      --ink:#d1d725;
      --ink-soft:rgba(209,215,37,.78);
      --hud:#0c1707;
      --hud2:#081106;
      --hud-border:#1d2c19;
      --hud-hi:rgba(255,255,200,.05);
      --hud-lo:rgba(0,0,0,.45);
      --accent:#7efc6b;

      /* timing */
      --spawn-ms: 3600;     /* drip build (longer for visible drips) */
      --sim-ms:   4200;     /* build end -> fade skull + paint (extend for visible drips) */
      --ansi-ms:  1600;     /* skull type-in speed */
      --neon-ms:  1800;     /* neon shower duration after reveal */

      /* ink look (light) */
      --max-particles: 400;
      --gutter: 24;

      --fade-alpha: 0.010;  /* build-phase decay inside mask */
      --red-core:   #ff0000;/* final solid logo */
      --ink-a:      rgba(255, 0, 0, 0.7);
      --ink-b:      rgba(60, 11, 11, 0.58);
      --ink-tail:   rgba(12, 3, 3, 0.55);
      --ink-add:    rgba(24, 12, 12, 0.38);

      /* physics */
      --grav: 0.050;
      --drag: 0.990;
      --stick-x: 0.92;
      --stick-y: 0.86;
      --wander: 0.05;
      --edge-bleed: 0.22;

      /* clears */
      --fadeout-alpha: 1.22; /* clears paint after build */
      --neon-clear:    1.30; /* clears neon each frame */
    }

    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--ink);
      font-family:'Share Tech Mono', monospace;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      /* Avoid notches and browser chrome overlapping content */
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .wrap{
      /* Scale to fit any screen, preserve aspect */
      width:min(96vw, 1200px);
      aspect-ratio: 5 / 3; /* ~1200x720 */
      height:auto;
      /* Cap height to visible viewport on mobile */
      max-height:min(92svh, 720px);
      position:relative; background:var(--hud); border:4px solid var(--hud-border);
      box-shadow: inset 0 2px 0 var(--hud-hi), inset 0 -2px 0 var(--hud-lo);
      box-sizing:border-box;
    }
    .wrap::before{
      content:""; position:absolute; inset:8px; pointer-events:none;
      border:2px solid rgba(20,40,18,0.85);
      box-shadow: inset 0 1px 0 rgba(255,255,220,0.05);
    }

    /* Stacking */
    canvas{ position:absolute; inset:0; display:block; image-rendering:pixelated; }
    #ansi{  z-index:0 }  /* skull */
    #logo{  z-index:1 }  /* final opaque wordmark */
    #paint{ z-index:2 }  /* drips / neon */
    #type{  z-index:3 }  /* paranoid caption */

    /* Hints */
    #hint{
      position:absolute; left:50%; bottom:8px; transform:translateX(-50%);
      font-size:clamp(10px, 2.5vw, 12px); letter-spacing:.06em; opacity:.82; z-index:4; user-select:none;
      color:var(--ink-soft);
      text-shadow:0 0 6px rgba(80,160,60,.25);
      white-space:normal; text-align:center; padding:0 8px;
      pointer-events:none;
    }

    /* START button: fixed near bottom, gated until ready */
    #startBtn{
      position:absolute;
      left:50%;
      bottom:clamp(8px, 6svh, 10%);
      transform:translateX(-50%);
      z-index:5;

      text-decoration:none;
      appearance:none;
      border:2px solid var(--hud-border);
      background:#102110;
      color:var(--ink);
      font-family:'Share Tech Mono', monospace;
      font-size:clamp(13px, 3.2vw, 22px);
      letter-spacing:.08em;
      padding:clamp(8px, 2.2vw, 14px) clamp(14px, 3.4vw, 24px);
      border-radius:8px;
      box-shadow:0 0 0 1px rgba(24,48,22,.7) inset, 0 0 24px rgba(126,252,107,.14);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, color .12s ease, border-color .12s ease, opacity .25s ease;
      touch-action: manipulation;

      /* gated by default */
      opacity:0;
      pointer-events:none;
    }
    #startBtn.ready{
      opacity:1;
      pointer-events:auto;
      box-shadow:0 0 0 1px rgba(30,60,26,.75) inset, 0 0 36px rgba(126,252,107,.18), 0 0 0 4px rgba(32,88,20,.32);
    }
    #startBtn:hover, #startBtn:focus-visible{
      outline:none;
      transform:translateX(-50%) translateY(-1px);
      background:#183118;
      border-color:#8cf874;
      box-shadow:0 0 0 1px rgba(46,92,40,.7) inset, 0 0 24px rgba(126,252,107,.22), 0 0 0 4px rgba(32,88,20,.32);
      color:#f6ffda;
    }
    #startBtn:active{
      transform:translateX(-50%);
      background:#142914;
      box-shadow:0 0 0 1px rgba(46,92,40,.75) inset, 0 0 18px rgba(126,252,107,.24);
    }

    /* Mono ASCII logo helper (used elsewhere); fix misplaced block and make scalable */
    .logo{
      font-family:'JetBrains Mono', monospace !important;
      font-size:6px;
      line-height:6px;
      letter-spacing:0;
      font-variant-ligatures:none;
      white-space:pre;
      display:block;
      color:var(--ink);
      opacity:.95;
      flex:0 0 auto;
      max-width:none;
      overflow:hidden;
    }
    .logo { transform: scale(0.85); transform-origin:left top; }

    /* Small screens: tighten spacing and hint */
    @media (max-width: 480px) {
      #hint { bottom: 6px; opacity: .78; }
      #startBtn { bottom: clamp(6px, 5svh, 12%); }
      :root { --max-particles: 300; }
    }
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <canvas id="ansi"></canvas>   <!-- skull (under) -->
    <canvas id="logo"></canvas>   <!-- opaque red logo -->
    <canvas id="paint"></canvas>  <!-- drips / neon -->
    <canvas id="type"></canvas>   <!-- FOG OF WAR title -->

    <!-- CTA (gated, bottom) -->
    <a id="startBtn" href="deployment.html" aria-label="Start Game">START GAME ▸</a>

    <div id="hint">SPACE — replay intro &nbsp;&nbsp;•&nbsp;&nbsp; ENTER — start (when ready)</div>
  </div>

  <!-- ASCII mask -->
  <script type="text/plain" id="ascii-src">
  
  
  
      
      █████   ████    ███████    ██████   ██████ ██████   ██████   █████████   ██████   █████ ██████████      ███████
      ▒▒███   ███▒   ███▒▒▒▒▒███ ▒▒██████ ██████ ▒▒██████ ██████   ███▒▒▒▒▒███ ▒▒██████ ▒▒███ ▒▒███▒▒▒▒███   ███▒▒▒▒▒███
       ▒███  ███    ███     ▒▒███ ▒███▒█████▒███  ▒███▒█████▒███  ▒███    ▒███  ▒███▒███ ▒███  ▒███   ▒▒███ ███     ▒▒███
       ▒███████    ▒███      ▒███ ▒███▒▒███ ▒███  ▒███▒▒███ ▒███  ▒███████████  ▒███▒▒███▒███  ▒███    ▒███▒███      ▒███
       ▒███▒▒███   ▒███      ▒███ ▒███ ▒▒▒  ▒███  ▒███ ▒▒▒  ▒███  ▒███▒▒▒▒▒███  ▒███ ▒▒██████  ▒███    ▒███▒███      ▒███
       ▒███ ▒▒███  ▒▒███     ███  ▒███      ▒███  ▒███      ▒███  ▒███    ▒███  ▒███  ▒▒█████  ▒███    ███ ▒▒███     ███
       █████ ▒▒████ ▒▒▒███████▒   █████     █████ █████     █████ █████   █████ █████  ▒▒█████ ██████████   ▒▒▒███████▒
      ▒▒▒▒▒   ▒▒▒▒    ▒▒▒▒▒▒▒    ▒▒▒▒▒     ▒▒▒▒▒ ▒▒▒▒▒     ▒▒▒▒▒ ▒▒▒▒▒   ▒▒▒▒▒ ▒▒▒▒▒    ▒▒▒▒▒ ▒▒▒▒▒▒▒▒▒▒      ▒▒▒▒▒▒▒
  </script>
  <script>
    (function(){
      const unlock = () => {
        if (window.KomAudio && typeof window.KomAudio.resume === 'function') {
          window.KomAudio.resume(true);
        }
      };
      ['pointerdown','mousedown','touchstart'].forEach(evt => window.addEventListener(evt, unlock, { once: true, passive: true }));
      window.addEventListener('keydown', unlock, { once: true });
    })();
  </script>

  <!-- Skull block (raw; no ANSI escapes) -->
  <script type="text/plain" id="skull-src">                                     
                                                                                                                    
                                                   ███  ▒ ▓▓  ░█                                                    
                                             ▒███▒█▓██░░░░████████▒▒███▓██                                          
                                        █▓ ▒    ░███▒░█▒███████████████████████                                     
                                      ███  ░█▓▒       ░████████████████████████████                                 
                                    ███████▓░░░░   ██████████████▓░▒███████████▓███▓░                               
                                    ███████████▓░░▓▓▓██████████░ ▓▓▒░██░ ▒███████████▓▓                             
                                ░░▓█▓▓███▓████████████████▒   ░▓ ░████████████████████████                          
                               ██████▓    ░▒░░░▓█████████████▓░▓▓██████▓███████████████████                         
                              ████████████░░░████████▓███████████████████████████████████████                       
                              ███████████████████▓░░░▒  ░█████████████████████████████████████                      
                              ████████████████████████▒█▒  ▒█▓░░      ░▒▓███████████████████▓█░                     
                             ████████░██████████████████████████████████▓▓▓▓▓░░░▓█████▒░█▓█████                     
                             █████▓   ██▓█████████████████████████████████████▒█████████████████                    
                             ███▓ ░▓███▓▒▒░░                ░▒▒▒▓████████████████████████▒████▒█                    
                             █░░██▒     ░       ░             ░▒▓░      ░▓██████▒██████▒  ░█▓ ▒█                    
                            ███░       ▓▒ ░▒░▓   ░░ ░     ▒░     ░█░▓▓█▓     ░░▓███████▒█░    ░█                    
                           ██▓    ░█▓░██▒ ▓█▓▓▓▓▒█▓ █░▓  ▒▓    ░██▓▓▒▒███▒ ░ ██░   ░██▓▓▓░    ▓█                    
                           █▓         █▓▒ ░█▓▓ ░░▒ ░░▓    ▓▓░  ███▓██▒█▓██░░ ▒███░     ▒█▓░░▓ ██                    
                           █▒      ░░▒█▒░   ▓▓░█░▒  █      █▓░ ███░███░███░  ▓████       ░█▓ ▒█                     
                            █░     ░░▒███░      ░  █░   ░  ▒███ ▒▒█░░▒███▒   █████▒   ░▒░  ░█░█                     
                             ▓      ██░▓██▓█████  ▓░   ▓▒   ███░█░         ░███████░ ▓   █░  ██                     
                             ▓      ░▓███▒░ ░▓   ░█ ▒  ▓▓   ▒██░███████████████████▓░█   █░   ██                    
                             ▓     ░██████▓▒█▒    █▒░░▓██░░░████░ ░░▒███████████████▓    █░    ██                   
                            █▒      ▒██████████  ░██▓▓▒▒▒▒░▓█▓██░ █▒█████████████████    ▓  ░█ ██                   
                            █     ░█ █▒░██▒▓░      ▒▓█▓▒█▒█▓█████  █▒███████████████▓    ▓ ░█                       
                            █     ▒   █░         ▒▓█▒█▒▓█▒█▓▓███▓░   ░▒███▒▒░     ▓▓█   █▓ ▓                        
                            █    ░█  ██▒ ▒▒░     ░░▒█░▓▒▓██▒▒████░     ▓████▓░ █░█      █░ █                        
                            █    ░█  ███▒▓▒    ░▒░▒▒▒▒█▒█▓▒█▓▓█▒█░▒░   ▒█████░▓▓██      ▓  █                        
                            █    ░█  ███████▓▒█░░█▒████░█▒██▒██▒█▓█▒    █████░░██       ▓ ░█                        
                            ▒     ▓ ██░▓▒█▒███████           ░░ ░      ░█████▓██        ▓ ░█                        
                           █     ░█ ███▓   ░▓██░▒░▒░ ░     ░▒░     ▒   ▓████████        ▓  █                        
                          █▒     ░█    █░ ▒        ░░            █░    ████████         ▓  █                        
                          ▓      ▒      ▓ ░▒     ░▓░▓███░██▓░█▒█▓█░░   ████████         █░ ▓                        
                         █░     ░█      █░ ░         ▒ ▓░▓▒█░█▒░▒░██▒ ▓███▒███           ▓ ▓                        
                        █▒     ░▓        ▓     ░    ░█░█ █░░▒░█░████▒ ███▓███            █░░█                       
                        ▓      ▒         █▒░▓  ░▒░ ░  ▓█▓▓██████████░▓██░▒██              ▓▒▒██                     
                       █░     ▒█          █▒▓▓░░░░▒░  ▓░░▓█████████████▓▒█                █░ ██                     
                      █░     ░█            █▓▓█▒▒   █▓█░█▓████████████░ ██                █▒░██                     
                    ██░     ░█               █████▒ █▓  ██████████▓█▒ ░██                 █▒░██                     
                   █░      ░█                 ██▒▓▒░     ██▒░▒███░░   ▓██                 █░░██                     
                  █░      ░█                   █░██████▓░ ██▓░░▒█████▒███                 ▓░░▓█                     
                 █░      ░█                    █▒██████▓░ ███████████▓▓██                █░▒ ░█                     
                █░      ▒█                     █████████▒ ████▒█████▒▓███                ▓ █░█                      
               ▓░      ▓█                       ██████▓▓  ██████████████                █░ ▓▓█                      
             █▒      ░█                          ██████▓░ ██████▒▓████                 █▓ ░▓█                       
             ▒     ░▓█                              ███▓░░██▒▓█████                    ▓  ░█                        
            █▒   ░▒█                                                                  █░ ▒██                        
             █████                                                                    ▓ ▒█                          
                                                                                     █░░█                           
                                                                                     ▒ ▓█                           
                                                                                    █░▒█                            
                                                                                    ▒░█                             
                                                                                   █▒█                              
  </script>

  <script>
    (async function(){
      const DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
      const wrap   = document.getElementById('wrap');
      const ansiC  = document.getElementById('ansi');  const ansiCtx  = ansiC.getContext('2d'); // skull
      const logoC  = document.getElementById('logo');  const logoCtx  = logoC.getContext('2d'); // final logo
      const paintC = document.getElementById('paint'); const pctx     = paintC.getContext('2d', { alpha:true });
      const typeC  = document.getElementById('type');  const typeCtx  = typeC.getContext('2d');
      const startBtn = document.getElementById('startBtn');

      const ASCII_LOGO = document.getElementById('ascii-src').textContent.replace(/\r/g,'');
      const SKULL_RAW  = document.getElementById('skull-src').textContent;

      // Ensure fonts are really ready before measuring
      if (document.fonts && document.fonts.ready) {
        try { await document.fonts.ready; } catch(e){}
      }
      try {
        await Promise.all([
          document.fonts.load(`400 16px "JetBrains Mono"`),
          document.fonts.load(`400 16px "Courier Prime"`),
          document.fonts.load(`400 16px "Share Tech Mono"`),
          document.fonts.load(`400 16px "Special Elite"`)
        ]);
      } catch(_) {}

      const ASCII_STACK = `"JetBrains Mono","Courier Prime","Share Tech Mono",monospace`;

      let w=0, h=0;
      let maskData=null, mW=0, mH=0, logoBox=null, chW=0, chH=0, rows=0, cols=0, offX=0, offY=0, fontPx=0;

      const css = () => getComputedStyle(document.documentElement);
      const MAX = () => parseInt(css().getPropertyValue('--max-particles')) || 1200;

      let particles=[], spawnUntil=0, stopAt=0, neonUntil=0, rafId=0, finalized=false;

      // phases: 0 BUILD, 1 FADE_PAINT, 2 NEON, 3 DONE
      let phase = 0;
      let introSoundPlayed = false;

      // skull text layout
      let skullLines=[], skullGeom=null, skullStart=0;

      // paranoid typewriter
      const TYPE_TEXT='FOG OF WAR';

      function fitCanvas(cv){
        const r = wrap.getBoundingClientRect();
        cv.width  = Math.floor(r.width * DPR);
        cv.height = Math.floor(r.height * DPR);
        cv.style.width  = r.width + 'px';
        cv.style.height = r.height + 'px';
      }

      function layout(){
        [ansiC, logoC, paintC, typeC].forEach(fitCanvas);
        const r = wrap.getBoundingClientRect();
        w = r.width; h = r.height;
        const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);

        [ansiCtx, logoCtx, pctx, typeCtx].forEach(ctx => {
          ctx.setTransform(DPR,0,0,DPR,0,0);
          ctx.globalCompositeOperation = 'source-over';
          ctx.globalAlpha = 1;
          ctx.clearRect(0,0,w,h);
        });

        // --- ASCII mask metrics (TOP ALIGNMENT) ---
        const lines = ASCII_LOGO.split('\n');
        rows = lines.length;
        cols = Math.max(...lines.map(l=>l.length || 0));

        fontPx = Math.floor(Math.min(
          w / Math.max(8, (cols + 2)),
          h / Math.max(8, (rows + 4))
        ));
        fontPx = Math.max(12, Math.min(fontPx, 40));
        // Mobile-only downsizing for the KOMMANDO ASCII logo
        if (isMobile) {
          fontPx = Math.max(4, Math.floor(fontPx * 0.25));
        }
        // Absolute vertical fit cap: ensure the ASCII block never overflows the canvas height
        (function enforceVerticalFit(){
          const offYtmp = Math.round(h * 0.06);
          const maxPxByHeight = Math.floor(((h - 10 - offYtmp) / (rows * 1.2)));
          if (isFinite(maxPxByHeight) && maxPxByHeight > 0) {
            fontPx = Math.min(fontPx, maxPxByHeight);
          }
          fontPx = Math.max(isMobile ? 4 : 12, fontPx);
        })();

        mW = Math.floor(w * DPR);
        mH = Math.floor(h * DPR);
        const mcv = document.createElement('canvas');
        mcv.width = mW; mcv.height = mH;
        const mctx = mcv.getContext('2d');
        mctx.setTransform(DPR,0,0,DPR,0,0);
        mctx.clearRect(0,0,w,h);
        mctx.fillStyle = '#fff';
        mctx.font = `${fontPx}px ${ASCII_STACK}`;
        mctx.textBaseline='top';

        // Measure using the actual block char to match glyph advance
        chW = mctx.measureText('█').width || mctx.measureText('M').width;
        chH = fontPx * 1.2;
        const blockW = chW * cols;
        const blockH = chH * rows;

        // Center KOMMANDO ASCII logo on screen
        offX = Math.round((w - blockW)/2);
        offY = Math.round((h - blockH)/2);

        for (let rI=0;rI<rows;rI++){
          const line = lines[rI];
          if (line && line.trim().length) mctx.fillText(line, Math.round(offX), Math.round(offY + rI*chH));
        }
        maskData = mctx.getImageData(0,0,mW,mH).data;

        logoBox = {x: offX, y: offY, w: blockW, h: blockH};

        // --- Skull placement (right side; adapts to new top) ---
        skullLines = SKULL_RAW.replace(/\r/g,'').split('\n');
        const sRows = skullLines.length;
        const sCols = skullLines.reduce((m,l)=>Math.max(m,l.length),0);

        const rightPad = 10, gutter = 14;
        const rightAvailW = Math.max(0, w - (offX + logoBox.w + gutter) - rightPad);
        const rightAvailH = h - 32;

        let sFontPx = Math.floor(Math.min(
          (rightAvailW>0? rightAvailW : w/2) / Math.max(6,(sCols+1)),
          rightAvailH / Math.max(6,(sRows+0.5))
        ));
        sFontPx = Math.max(6, Math.min(sFontPx, 28));
        // Mobile-only downsizing for the skull block; enlarge on desktop
        if (isMobile) {
          sFontPx = Math.max(6, Math.floor(sFontPx * 0.50));
        } else {
          const maxByW = Math.floor(((rightAvailW>0? rightAvailW : w/2) / Math.max(6,(sCols+1))));
          const maxByH = Math.floor(rightAvailH / Math.max(6,(sRows+0.5)));
          sFontPx = Math.floor(sFontPx * 1.20);
          sFontPx = Math.max(8, Math.min(sFontPx, maxByW, maxByH, 42));
        }
        ansiCtx.font = `${sFontPx}px ${ASCII_STACK}`;
        ansiCtx.textBaseline = 'top';
        const sChW = ansiCtx.measureText('█').width || ansiCtx.measureText('M').width;
        const sChH = sFontPx * 1.2;

        const sTotalW = sChW * sCols;
        const sTotalH = sChH * sRows;

        let left = offX + logoBox.w + gutter;
        left = Math.min(left, w - sTotalW - rightPad);
        const top  = Math.max(12, Math.floor((h - sTotalH)/2) - Math.floor(h*0.08)); // nudge skull ASCII upward

        skullGeom = { left: Math.round(left), top: Math.round(top), cols:sCols, rows:sRows, chW:sChW, chH:sChH, fontPx:sFontPx };
      }

      /* --------- helpers --------- */
      function maskAtSmooth(x,y){
        if(!maskData) return 0;
        const taps = [[x,y],[x+0.35,y+0.15],[x-0.35,y-0.15],[x,y+0.35]];
        let acc = 0;
        for(const [sx,sy] of taps){
          const ix = Math.max(0, Math.min(mW-1, Math.floor(sx * DPR)));
          const iy = Math.max(0, Math.min(mH-1, Math.floor(sy * DPR)));
          const idx = (iy * mW + ix) * 4 + 3; // alpha
          acc += (maskData[idx] > 10) ? 1 : 0;
        }
        return acc / taps.length;
      }
      function field(x,y){
        const l=maskAtSmooth(x-1,y), r=maskAtSmooth(x+1,y), u=maskAtSmooth(x,y-1), d=maskAtSmooth(x,y+1);
        return {gx:(r-l), gy:(d-u)};
      }

      function spawnParticle(build=true){
        const band = Math.max(20, Math.floor(logoBox.w));
        const startX = logoBox.x + Math.random() * band;
        const wander = parseFloat(css().getPropertyValue('--wander'))||0.05;
        const baseVy = build ? (0.55 + Math.random()*0.45) : (0.75 + Math.random()*0.35);
        const r  = build ? (1.6 + Math.random()*2.2) : (1.0 + Math.random()*1.6);
        const startY = (logoBox.y - Math.max(60, Math.floor(logoBox.h * 0.25))) - Math.random()*40;
        return {
          x: startX,
          y: startY,
          vx:(Math.random()-0.5) * wander,
          vy: baseVy,
          r,
          life: 0,
          px: null, py: null,
          neon: !build
        };
      }

      function deposit(p, mode){
        const inside = maskAtSmooth(p.x,p.y) > 0.18;
        pctx.save();
        if(mode==='BUILD'){
          pctx.beginPath(); pctx.rect(logoBox.x, logoBox.y, logoBox.w, logoBox.h); pctx.clip();
        }
        if(p.px!==null){
          const cx = (p.px + p.x) * 0.5;
          const cy = (p.py + p.y) * 0.5 - Math.min(4, p.vy*1.8);

          pctx.globalCompositeOperation = (mode==='NEON') ? 'screen' : 'lighter';
          pctx.globalAlpha = (mode==='NEON') ? 0.6 : 0.75;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim();
          pctx.lineWidth = Math.max(0.9, p.r*0.70);
          pctx.lineCap = 'round';
          pctx.beginPath(); pctx.moveTo(p.px, p.py);
          pctx.quadraticCurveTo(cx, cy, p.x, p.y);
          pctx.stroke();

          pctx.globalCompositeOperation = 'source-over';
          pctx.globalAlpha = (mode==='NEON') ? 0.45 : 0.55;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-tail').trim();
          pctx.lineWidth = Math.max(0.7, p.r*0.48);
          pctx.beginPath(); pctx.moveTo(p.px, p.py+0.3);
          pctx.quadraticCurveTo(cx, cy+0.3, p.x, p.y-0.2);
          pctx.stroke();
        }
        const g = pctx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.r*1.2);
        g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim());
        g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--ink-b').trim());
        pctx.globalCompositeOperation = (mode==='NEON') ? 'screen' : 'lighter';
        pctx.globalAlpha = (mode==='NEON') ? 0.65 : 0.75;
        pctx.fillStyle = g;
        pctx.beginPath(); pctx.arc(p.x, p.y, p.r, 0, Math.PI*2); pctx.fill();

        if(mode==='BUILD' && inside){
          const bleed = parseFloat(css().getPropertyValue('--edge-bleed'))||0.22;
          const F = field(p.x,p.y);
          const tx = -F.gy, ty = F.gx;
          const norm = Math.hypot(tx,ty)||1;
          const ex = (tx/norm)*(p.r*1.1);
          const ey = (ty/norm)*(p.r*1.1);
          pctx.globalCompositeOperation = 'lighter';
          pctx.globalAlpha = 0.5;
          pctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ink-a').trim();
          pctx.lineWidth = Math.max(0.6, p.r*0.42*bleed);
          pctx.beginPath();
          pctx.moveTo(p.x - ex, p.y - ey);
          pctx.lineTo(p.x + ex, p.y + ey);
          pctx.stroke();
        }
        pctx.restore();
        p.px = p.x; p.py = p.y;
      }

      function drawSkullFrame(ts){
        if(!skullGeom) return;
        const {left, top, cols, rows, chW, chH, fontPx} = skullGeom;
        const t = Math.max(0, Math.min(1, (ts - skullStart)/ (parseInt(css().getPropertyValue('--ansi-ms'))||1600)));
        const revealCols = Math.ceil(cols * t);

        // draw skull progressively (no fade)
        ansiCtx.save();
        ansiCtx.globalCompositeOperation = 'source-over';
        ansiCtx.clearRect(0,0,w,h);
        ansiCtx.font = `${fontPx}px ${ASCII_STACK}`;
        ansiCtx.textBaseline = 'top';
        ansiCtx.fillStyle = '#eaeaea';
        for (let r=0;r<rows;r++){
          const slice = (skullLines[r]||'').slice(0,revealCols);
          if (slice.trim().length){
            // Right-align each row while revealing left->right
            const padCols = cols - slice.length;
            ansiCtx.fillText(slice, Math.round(left + padCols*chW), Math.round(top + r*chH));
          }
        }
        ansiCtx.restore();
      }

      function finalSolidLogo(){
        if(finalized) return; finalized = true;
        // draw OPAQUE logo (sits near top)
        logoCtx.save();
        logoCtx.globalCompositeOperation='source-over';
        logoCtx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--red-core').trim() || '#ff0000';
        logoCtx.font = `${fontPx}px ${ASCII_STACK}`;
        logoCtx.textBaseline = 'top';
        const lines = ASCII_LOGO.split('\n');
        for (let rI=0;rI<rows;rI++){
          const line = lines[rI];
          if (line && line.trim().length) logoCtx.fillText(line, Math.round(offX), Math.round(offY + rI*chH));
        }
        logoCtx.restore();
      }

      /* -------- FOG OF WAR title (under logo near top) -------- */
      function startTypewriter(){
        const maxW = Math.floor(logoBox.w*0.95);
        let ts = Math.min(64, Math.max(18, Math.floor(maxW/(TYPE_TEXT.length*0.62))));
        // Slightly smaller subtitle for balance
        ts = Math.max(14, Math.floor(ts * 0.80));
        const isMobile = (window.matchMedia && window.matchMedia('(max-width: 768px)').matches);
        let y;
        let cx;
        if (isMobile) {
          // On mobile, place FOG OF WAR at top center above the logo
          y = Math.max(24, logoBox.y - Math.floor(ts * 1.4));
          cx = Math.floor(w / 2);
        } else {
          y  = Math.min(h*0.52, logoBox.y + logoBox.h + Math.max(20, Math.floor(logoBox.h*0.08)));
          cx = Math.floor(logoBox.x + logoBox.w/2);
        }
        // Bring text 40px down from current position for better spacing
        y = y + 40;

        let idx=0, typing=true, caretOn=true;
        const accent = (getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#8cf874').trim();

        const draw = () => {
          typeCtx.clearRect(logoBox.x, y-ts*1.2, logoBox.w, ts*2.4);
          typeCtx.textBaseline='middle'; typeCtx.textAlign='center';
          const txt = TYPE_TEXT.slice(0, idx);
          typeCtx.font = `${Math.round(ts)}px "Special Elite", "Courier Prime", monospace`;

          // Black shadow for readability
          typeCtx.save();
          typeCtx.globalAlpha = 0.9;
          typeCtx.fillStyle = '#000';
          const sx = 2, sy = 2;
          typeCtx.fillText(txt, cx + sx, y + sy);
          typeCtx.restore();

          // Neon accent color instead of grey
          typeCtx.globalAlpha = 0.65; typeCtx.fillStyle = accent;
          typeCtx.fillText(txt, cx + (Math.random()*0.8-0.4), y + (Math.random()*0.8-0.4));
          typeCtx.globalAlpha = 0.95; typeCtx.fillStyle = accent;
          typeCtx.fillText(txt, cx + (Math.random()*0.4-0.2), y + (Math.random()*0.4-0.2));

          if(typing && caretOn){
            const measureAll = typeCtx.measureText(TYPE_TEXT);
            const pre = TYPE_TEXT.slice(0, Math.max(0,idx));
            const meas = typeCtx.measureText(pre);
            const caretX = cx - (measureAll.width/2) + meas.width + 3;
            const ch = Math.floor(ts*0.96);
            typeCtx.globalAlpha = 0.85;
            typeCtx.fillRect(caretX, y - ch*0.55, Math.max(2, ts*0.07), ch*0.95);
          }
          typeCtx.globalAlpha = 1;
        };

        (function step(){
          if(idx<=TYPE_TEXT.length){ draw(); idx++; setTimeout(step, 48 + (Math.random()*40|0)); }
          else { typing=false; draw(); }
        })();

        (function blink(){
          caretOn = !caretOn;
          if(!typing) { draw(); return; }
          draw(); setTimeout(blink, 360 + (Math.random()*240|0));
        })();
      }

      function revealStartBtn(){
        if(!startBtn.classList.contains('ready')){
          startBtn.classList.add('ready');
          startBtn.focus({ preventScroll: true });
        }
      }
      function hideStartBtn(){
        startBtn.classList.remove('ready');
        if (document.activeElement === startBtn) startBtn.blur();
      }

      function tick(ts){
        // phase transitions
        if(phase===0 && ts >= stopAt){ phase = 1; finalSolidLogo(); }
        if(phase===1 && ts >= stopAt + 500){ phase = 2; }
        if(phase===2 && ts >= neonUntil){ phase = 3; revealStartBtn(); }

        // per-phase clears (paint)
        if(phase===0){
          pctx.save(); pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--fade-alpha')||0.010})`;
          pctx.fillRect(logoBox.x, logoBox.y, logoBox.w, logoBox.h); pctx.restore();
        } else if(phase===1){
          pctx.save(); pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--fadeout-alpha')||0.22})`;
          pctx.fillRect(0,0,w,h); pctx.restore();
        } else if(phase===2){
          pctx.save(); pctx.globalCompositeOperation='destination-out';
          pctx.fillStyle=`rgba(0,0,0,${css().getPropertyValue('--neon-clear')||0.30})`;
          pctx.fillRect(0,0,w,h); pctx.restore();
        }

        // spawn / simulate
        const G = parseFloat(css().getPropertyValue('--grav'))||0.05;
        const DRAG = parseFloat(css().getPropertyValue('--drag'))||0.990;

        if(phase===0 && ts<spawnUntil && particles.length<MAX()){
          for(let i=0;i<12;i++) particles.push(spawnParticle(true));
        }
        if(phase===2 && particles.length<Math.floor(MAX()*0.35)){
          for(let i=0;i<6;i++) particles.push(spawnParticle(false));
        }

        for(let i=particles.length-1;i>=0;i--){
          const p=particles[i];
          p.vy += G;
          const F=field(p.x,p.y);
          p.vx += F.gx*0.12;
          p.vy += F.gy*0.12;
          p.vx *= DRAG; p.vy *= DRAG;
          p.px = (p.px===null)? p.x : p.x;
          p.py = (p.py===null)? p.y : p.y;
          p.x  += p.vx; p.y  += p.vy;

          if(phase===0){
            if(maskAtSmooth(p.x,p.y)>0.18){
              p.vx *= (parseFloat(css().getPropertyValue('--stick-x'))||0.92);
              p.vy  = Math.max(0.18, p.vy*(parseFloat(css().getPropertyValue('--stick-y'))||0.86));
            }
            deposit(p,'BUILD');
          } else if(phase===2){
            deposit(p,'NEON');
          }

          if(p.x<-24||p.x>w+24||p.y>h+50) particles.splice(i,1);
        }

        // skull draw (no fade)
        drawSkullFrame(ts);

        if(phase<3){ rafId=requestAnimationFrame(tick); }
      }

      function start(){
        cancelAnimationFrame(rafId);
        finalized=false;
        particles.length = 0;
        phase = 0;
        hideStartBtn();

        [ansiCtx, logoCtx, pctx, typeCtx].forEach(ctx=>{
          ctx.setTransform(1,0,0,1,0,0);
          ctx.globalCompositeOperation='source-over';
          ctx.globalAlpha=1;
          ctx.clearRect(0,0,99999,99999);
        });

        layout();

        const now = performance.now();
        skullStart = now;
        spawnUntil = now + (parseInt(css().getPropertyValue('--spawn-ms'))||2200);
        stopAt     = now + (parseInt(css().getPropertyValue('--sim-ms'))  ||1800);
        neonUntil  = stopAt + (parseInt(css().getPropertyValue('--neon-ms'))||1800);

        if(!introSoundPlayed && window.KomAudio){
          introSoundPlayed = true;
          window.KomAudio.playIntro();
        }

        // Start the FOG OF WAR typewriter later for better pacing
        setTimeout(()=> startTypewriter(), Math.max(80, (spawnUntil-now) + 1200));
        rafId = requestAnimationFrame(tick);
      }

      // ---- Controls ----
      window.addEventListener('resize', start, {passive:true});

      // Click anywhere (except the Start button) to replay
      document.addEventListener('click', (e)=>{
        if (e.target && e.target.closest && e.target.closest('#startBtn')) return;
        start();
      }, {passive:true});

      // Keyboard: Space = replay, Enter = start (only when ready)
      window.addEventListener('keydown', e=>{
        if(e.code==='Space'){ e.preventDefault(); start(); }
        if(e.code==='Enter' && startBtn.classList.contains('ready')){
          e.preventDefault();
          if(window.KomAudio && window.KomAudio.resume){ window.KomAudio.resume(true); }
          window.location.href = 'deployment.html';
        }
      });

      // Button click navigates (when ready); stop propagation so it doesn’t trigger replay
      startBtn.addEventListener('click', (e)=>{
        if(!startBtn.classList.contains('ready')){
          e.preventDefault(); return;
        }
        if(window.KomAudio && window.KomAudio.resume){ window.KomAudio.resume(true); }
        e.stopPropagation(); // allow href to navigate
      });

      // Kick things off
      start();
    })();
  </script>
</body>
</html>
